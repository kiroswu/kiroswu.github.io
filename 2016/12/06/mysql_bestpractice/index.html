<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!--<![endif]-->

<head>
  <title>MySQL最佳实践 | Kiros&#39;s Blog</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="Kiros's Blog">
    <meta name="author" content="Kiros Wu">
    <meta name="description" content="Day Day Up" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="Kiros&#39;s Blog" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
	
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    
    

   <link rel="stylesheet" type="text/css" href="/css/ie8.css" />

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->










  
  
  <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="atom.xml">
  
  

  
  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            
        	<li>
        		<a class="sb-toggle-submenu">Categories<span class="sb-caret"></span></a>
            	<ul class="sb-submenu">
				  	
				    <li><a href="/categories/DB/" class="animsition-link">DB<small>(1)</small></a></li>
				    
				    <li><a href="/categories/Java/" class="animsition-link">Java<small>(3)</small></a></li>
				    
				    <li><a href="/categories/Linux/" class="animsition-link">Linux<small>(1)</small></a></li>
				    
				</ul>
        	</li>
			
            
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a href="http://kirosblog.cn/" class="animsition-link">Kiros</a></li>
                    
                    <li><a href="http://domain.com/" class="animsition-link">Name</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/kiros.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">Kiros's Blog</a></li>
                            <li class="nolink"><span>Always Creative</span></li>
                            
                            <li><a href="https://github.com/kiroswu" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a></li>
                            
                            
                            <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a></li>
                            
                            
                            <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a></li>
                            
                            
                            <li><a href="http://weibo.com/u/2363324471" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a></li>
                            
                            <li class="nolink"><span>Welcome!</span></li>
							<li>
							<input type="text" id="local-search-input" name="q" results="0" placeholder="Don't worry, search articles here!" class="st-search-input st-default-search-input form-control" style="display:inline;"/>
							</li>
							<div id="local-search-result"></div>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->


      
<section id="intro">
    <div class="container">	
        <div class="row">
		<!-- Table of Contents -->
			
			<div id="toc">
			<img class="toc-bg" src="/img/toc_bg_h.png"></img><br>
			<div class="toc-content col-md-3">
			<strong class="toc-title">CONTENTS</strong>
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#优化查询的查询缓存"><span class="toc-text">优化查询的查询缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引并对连接使用同样的字段类型"><span class="toc-text">索引并对连接使用同样的字段类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#不要ORDER-BY-RAND"><span class="toc-text">不要ORDER BY RAND()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#避免使用SELECT"><span class="toc-text">避免使用SELECT *</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#几乎总是有一个id字段"><span class="toc-text">几乎总是有一个id字段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#相比VARCHAR优先使用ENUM"><span class="toc-text">相比VARCHAR优先使用ENUM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#用PROCEDURE-ANALYSE-获取建议"><span class="toc-text">用PROCEDURE ANALYSE()获取建议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#如果可以的话使用NOT-NULL"><span class="toc-text">如果可以的话使用NOT NULL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#预处理语句"><span class="toc-text">预处理语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#无缓冲查询"><span class="toc-text">无缓冲查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用-UNSIGNED-INT-存储IP地址"><span class="toc-text">使用 UNSIGNED INT 存储IP地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#固定长度（静态）的表会更快"><span class="toc-text">固定长度（静态）的表会更快</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#垂直分区"><span class="toc-text">垂直分区</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#拆分大型DELETE或INSERT语句"><span class="toc-text">拆分大型DELETE或INSERT语句</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#越少的列越快"><span class="toc-text">越少的列越快</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#选择正确的存储引擎"><span class="toc-text">选择正确的存储引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用对象关系映射器（ORM-Object-Relational-Mapper）"><span class="toc-text">使用对象关系映射器（ORM, Object Relational Mapper）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小心使用持久连接"><span class="toc-text">小心使用持久连接</span></a></li></ol>
			</div>
			</div>
			
            <div class="col-md-9 col-md-offset-3">
    			<span class="post-meta">
      <time datetime="2016-12-05T16:00:00.000Z" itemprop="datePublished">
          2016-12-06
      </time>
    
    
    | 
    <a href='/tags/Mysql/'>Mysql</a>,
    
    <a href='/tags/DB/'>DB</a>,
    
    <a href='/tags/数据库/'>数据库</a>
    
    
</span>
                <h1>MySQL最佳实践</h1> 
				<span class="post-count">Total : 4,486words |</span>
				<span class="post-count">Read spends : 16mins</span>
				<hr class="nogutter">	
				<h2 id="优化查询的查询缓存"><a href="#优化查询的查询缓存" class="headerlink" title="优化查询的查询缓存"></a>优化查询的查询缓存</h2><p>大部分MySQL服务器都有查询缓存功能。这是提高性能的最有效的方法之一，这是由数据库引擎私下处理的。当同一个查询被多次执行，结果会直接从缓存里提取，这样速度就很快。</p>
<p>主要的问题是，这对程序员来说太简单了，不容易看到，我们很多人都容易忽略。我们实际上是可以组织查询缓存执行任务的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// query cache does NOT work</div><div class="line">$r = mysql_query(&quot;SELECT username FROM user WHERE signup_date &gt;= CURDATE()&quot;);</div><div class="line">  </div><div class="line">// query cache works!</div><div class="line">$today = date(&quot;Y-m-d&quot;);</div><div class="line">$r = mysql_query(&quot;SELECT username FROM user WHERE signup_date &gt;= &apos;$today&apos;&quot;);</div></pre></td></tr></table></figure></p>
<p>查询缓存在第一行不执行的原因在于CURDTE()功能的使用。这适用于所有的非确定性功能，就像NOW()和RAND()等等。。。因为功能返回的结果是可变的。MySQL决定禁用查询器的查询缓存。我们所需要做的是通过添加一额外一行PHP，在查询前阻止它发生。</p>
<p>##EXPLAIN你的选择查询<br>使用EXPLAIN关键词可以帮助了解MySQL是怎样运行你的查询的。这有助于发现瓶颈和查询或表结构的其它问题。</p>
<p>EXPLAIN的查询结果会展示哪一个索引被使用过，表示怎样扫描和储存的，等等。。。</p>
<p>选择一个SELECT查询（一个有连接的复杂查询会更好），在它的前面添加关键词EXPLAIN，这样就可以直接使用数据库了。结果会以一个漂亮的表来展示。例如，就好比我执行连接时忘了添加一栏的索引：</p>
<p>现在它只会从表2里面扫描9和16行，而非扫描7883行。经验法则是乘以所有“行”那一栏的数字，你的查询性能会跟结果数字成比例的。</p>
<p>##获取唯一行时使用LIMIT 1<br>有时当你查表时，你已经知道你正在查找的结果只有一行。你可能正在获取唯一记录，或者你可能只是查询是否存在满足你的WHERE子句条件的记录。</p>
<p>在这种情况下，将LIMIT 1添加到查询条件中可以提高性能。这样，数据库引擎将在找到刚刚第一个记录之后停止扫描记录，而不是遍历整个表或索引。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">// do I have any users from Alabama?</div><div class="line">  </div><div class="line">// what NOT to do:</div><div class="line">$r = mysql_query(&quot;SELECT * FROM user WHERE state = &apos;Alabama&apos;&quot;);</div><div class="line">if (mysql_num_rows($r) &gt; 0) &#123;</div><div class="line">    // ...</div><div class="line">&#125;</div><div class="line">  </div><div class="line">// much better:</div><div class="line">$r = mysql_query(&quot;SELECT 1 FROM user WHERE state = &apos;Alabama&apos; LIMIT 1&quot;);</div><div class="line">if (mysql_num_rows($r) &gt; 0) &#123;</div><div class="line">    // ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>##索引搜索字段<br>索引不仅仅是为了主键或唯一键。如果你会在你的表中按照任何列搜索，你就都应该索引它们。</p>
<p>正如你所看到的，这个规则也适用于如 “last_name LIKE ‘a%’”的部分字符串搜索。当从字符串的开头搜索时，MySQL就可以使用那一列的索引。</p>
<p>你也应该明白什么样搜索可以不使用有规律的索引。例如，当搜索一个单词时（例如，”WHERE post_content LIKE ‘%apple%’”），你将不会看到普通索引的好处。你最好使用 mysql 全文搜索或者构建你自己的索引解决方案。</p>
<h2 id="索引并对连接使用同样的字段类型"><a href="#索引并对连接使用同样的字段类型" class="headerlink" title="索引并对连接使用同样的字段类型"></a>索引并对连接使用同样的字段类型</h2><p>如果你的应用程序包含许多连接查询, 你需要确保连接的字段在两张表上都建立了索引。 这会影响MySQL如何内部优化连接操作。</p>
<p>此外,被连接的字段,需要使用同样类型。例如, 如果你使用一个DECIMAL字段, 连接另一张表的INT字段, MySQL将无法使用至少一个索引。 即使字符编码也需要使用相同的字符类型。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">// looking for companies in my state</div><div class="line">$r = mysql_query(&quot;SELECT company_name FROM users</div><div class="line">    LEFT JOIN companies ON (users.state = companies.state)</div><div class="line">    WHERE users.id = $user_id&quot;);</div><div class="line">  </div><div class="line">// both state columns should be indexed</div><div class="line">// and they both should be the same type and character encoding</div><div class="line">// or MySQL might do full table scans</div></pre></td></tr></table></figure></p>
<h2 id="不要ORDER-BY-RAND"><a href="#不要ORDER-BY-RAND" class="headerlink" title="不要ORDER BY RAND()"></a>不要ORDER BY RAND()</h2><p>起初这是一个听起来挺酷的技巧, 让许多菜鸟程序员陷入了这个陷阱。但你可能不知道，一旦你开始在查询中使用它，你创建了非常可怕的查询瓶颈。</p>
<p>如果你真的需要对结果随机排序, 这有一个更好的方法。补充一些额外代码,你将可以防止当数据成指数级增长时造成的瓶颈。关键问题是，MySQL必须在排序之前对表中的每一行执行RAND()操作（这需要处理能力），并且仅仅给出一行。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">// what NOT to do:</div><div class="line">$r = mysql_query(&quot;SELECT username FROM user ORDER BY RAND() LIMIT 1&quot;);</div><div class="line">  </div><div class="line">// much better:</div><div class="line">  </div><div class="line">$r = mysql_query(&quot;SELECT count(*) FROM user&quot;);</div><div class="line">$d = mysql_fetch_row($r);</div><div class="line">$rand = mt_rand(0,$d[0] - 1);</div><div class="line">  </div><div class="line">$r = mysql_query(&quot;SELECT username FROM user LIMIT $rand, 1&quot;);</div></pre></td></tr></table></figure></p>
<p>所以挑选一个小于结果数的随机数，并将其用作LIMIT子句中的偏移量。</p>
<h2 id="避免使用SELECT"><a href="#避免使用SELECT" class="headerlink" title="避免使用SELECT *"></a>避免使用SELECT *</h2><p>从数据表中读取的数据越多，查询操作速度就越慢。它增加了磁盘操作所需的时间。此外，当数据库服务器与Web服务器分开时，由于必须在服务器之间传输数据，将会有更长的网络延迟。</p>
<p>这是一个好习惯：当你使用SELECT语句时总是指定你需要的列。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">// not preferred</div><div class="line">$r = mysql_query(&quot;SELECT * FROM user WHERE user_id = 1&quot;);</div><div class="line">$d = mysql_fetch_assoc($r);</div><div class="line">echo &quot;Welcome &#123;$d[&apos;username&apos;]&#125;&quot;;</div><div class="line">  </div><div class="line">// better:</div><div class="line">$r = mysql_query(&quot;SELECT username FROM user WHERE user_id = 1&quot;);</div><div class="line">$d = mysql_fetch_assoc($r);</div><div class="line">echo &quot;Welcome &#123;$d[&apos;username&apos;]&#125;&quot;;</div><div class="line">  </div><div class="line">// the differences are more significant with bigger result sets</div></pre></td></tr></table></figure></p>
<h2 id="几乎总是有一个id字段"><a href="#几乎总是有一个id字段" class="headerlink" title="几乎总是有一个id字段"></a>几乎总是有一个id字段</h2><p>在每个以id列为PRIMARY KEY的数据表中，优先选择AUTO_INCREMENT或者INT。 也可以优选使用UNSIGNED，因为该值不能为负的。</p>
<p>即使你拥有一个具有唯一用户名字段的用户表，也不要将其作为主键。 VARCHAR字段作为主键（检索）速度较慢。通过内部ID引用所有的用户数据，你的代码中将更加结构化。</p>
<p>有些后台操作是由MySQL引擎本身完成的，它在内部使用主键字段。当数据库设置越复杂（集群，分区等…），这就变得更加重要了。</p>
<p>这个规则的一个可能的例外是“关联表”，用于两个表之间的多对多类型的关联。例如，“posts_tags”表中包含两列：post_id，tag_id，用于保存表名为“post”和“tags”的两个表之间的关系。这些表可以具有包含两个id字段的PRIMARY键。</p>
<h2 id="相比VARCHAR优先使用ENUM"><a href="#相比VARCHAR优先使用ENUM" class="headerlink" title="相比VARCHAR优先使用ENUM"></a>相比VARCHAR优先使用ENUM</h2><p>ENUM枚举类型是非常快速和紧凑的。在内部它们像TINYINT一样存储，但它们可以包含和显示字符串值。这使他们成为某些领域的完美候选。</p>
<p>如果有一个字段只包含几种不同的值，请使用ENUM而不是VARCHAR。例如，它可以是名为“status”的列，并且只包含诸如“active”，“inactive”，“pending”，“expired”等的值…</p>
<p>关于如何重构你的数据表，甚至有一种方法是可以从MySQL本身得到“建议”。 当你有一个VARCHAR字段，它实际上建议你将该列类型更改为ENUM。这通过调用PROCEDURE ANALYZE()来完成。 </p>
<h2 id="用PROCEDURE-ANALYSE-获取建议"><a href="#用PROCEDURE-ANALYSE-获取建议" class="headerlink" title="用PROCEDURE ANALYSE()获取建议"></a>用PROCEDURE ANALYSE()获取建议</h2><p>PROCEDURE ANALYSE() 将使用MySQL分析列结构和表中的实际数据，为你提供一些建议。它只有在数据表中有实际数据时才有用，因为这在分析决策时很重要。<br>例如，如果你创建了一个INT类型的主键，但没有太多行，MySQL则可能建议您改用MEDIUMINT。或者如果你使用VARCHAR字段，如果表里只有很少的取值，你可能会得到一个建议是将其转换为ENUM。<br>你也可以在其中一个表视图中单击phpmyadmin中的“建议表结构”链接来执行此操作。<br>请记住，这些只是建议。 如果你的数据表变得越来越大，他们甚至可能不是正确的建议。至于如何修改最终是你来决定。</p>
<h2 id="如果可以的话使用NOT-NULL"><a href="#如果可以的话使用NOT-NULL" class="headerlink" title="如果可以的话使用NOT NULL"></a>如果可以的话使用NOT NULL</h2><p>除非你有非常重要的理由使用NULL值，否则你应该设置你的列为NOT NULL。<br>首先，问一下你自己在空字符串值和NULL值之间（对应INT字段：0 vs. NULL）是否有任何的不同.如果没有理由一起使用这两个，那么你就不需要一个NULL字段（你知道在Oracle中NULL和空字符串是一样的吗？）。<br>NULL列需要额外的空间，他们增加了你的比较语句的复杂度。如果可以的话尽量避免它们。当然，我理解一些人，他们也许有非常重要的理由使用NULL值，这不总是一件坏事。<br>摘自MySQL 文档：<br>“NULL列在行记录它们的值是否为NULL时需要额外的空间。例如MyISAM 表，每一个NULL列拥有额外的一个比特，聚集在最近的字节。”</p>
<h2 id="预处理语句"><a href="#预处理语句" class="headerlink" title="预处理语句"></a>预处理语句</h2><p>使用预处理语句有诸多好处，包括更高的性能和更好的安全性。<br>预处理语句默认情况下会过滤绑定到它的变量，这对于避免SQL注入攻击极为有效。当然你也可以指定要过滤的变量。但这些方法更容易出现人为错误，也更容易被程序员遗忘。这在使用框架或 ORM 的时候会出现一些问题。<br>既然我们关注性能，那就应该说说这个方面的好处。当在应用中多次使用同一个查询的时候，它的好处特别明显。既然向同一个预备好的语句中传入不同的参数值，MySQL 对这个语句也只会进行一次解析。<br>同时，最新版本的 MySQL 在传输预备好的语句时会采用二进制形式，这样做的作用非常明显，而且对减少网络延迟很有帮助。<br>曾经有一段时间，许多程序员为了一个重要的原因则避免使用预处理语句。这个原因就是，它们不会被MySQL 缓存。不过在 5.1 版本的某个时候，查询缓存也得到的支持。<br>想在 PHP 中使用预处理语句，你可以看看 mysqli 扩展 或使用数据抽象层，如 PDO。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"> // create a prepared statement</div><div class="line">if ($stmt = $mysqli-&gt;prepare(&quot;SELECT username FROM user WHERE state=?&quot;)) &#123;</div><div class="line">  </div><div class="line">    // bind parameters</div><div class="line">    $stmt-&gt;bind_param(&quot;s&quot;, $state);</div><div class="line">  </div><div class="line">    // execute</div><div class="line">    $stmt-&gt;execute();</div><div class="line">  </div><div class="line">    // bind result variables</div><div class="line">    $stmt-&gt;bind_result($username);</div><div class="line">  </div><div class="line">    // fetch value</div><div class="line">    $stmt-&gt;fetch();</div><div class="line">  </div><div class="line">    printf(&quot;%s is from %s\n&quot;, $username, $state);</div><div class="line">  </div><div class="line">    $stmt-&gt;close();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="无缓冲查询"><a href="#无缓冲查询" class="headerlink" title="无缓冲查询"></a>无缓冲查询</h2><p>通常当你从脚本执行一个查询，在它可以继续后面的任务之前将需要等待查询执行完成。你可以使用无缓冲的查询来改变这一情况。<br>在PHP 文档中对  mysql_unbuffered_query() f函数有一个很好的解释：<br>“<br> “mysql_unbuffered_query() 发送SQL查询语句到MySQL不会像 mysql_query()那样自动地取并缓冲结果行。这让产生大量结果集的查询节省了大量的内存，在第一行已经被取回时你就可以立即在结果集上继续工作，而不用等到SQL查询被执行完成。”<br>然而，它有一定的局限性。你必须在执行另一个查询之前读取所有的行或调用mysql_free_result() 。另外你不能在结果集上使用mysql_num_rows() 或 mysql_data_seek() 。</p>
<h2 id="使用-UNSIGNED-INT-存储IP地址"><a href="#使用-UNSIGNED-INT-存储IP地址" class="headerlink" title="使用 UNSIGNED INT 存储IP地址"></a>使用 UNSIGNED INT 存储IP地址</h2><p>很多程序员没有意识到可以使用整数类型的字段来存储 IP 地址，所以一直使用 VARCHAR(15) 类型的字段。使用 INT 只需要 4 个字节的空间，而且字段长度固定。</p>
<p>必须确保列是 UNSINGED INT 类型，因为 IP 地址可能会用到 32 位无符号整型数据的每一个位。</p>
<p>在查询中可以使用 INET_ATON() 来把一个IP转换为整数，用 INET_NTOA() 来进行相反的操作。在 PHP 也有类似的函数，ip2long() 和 long2ip()。<br>$r = “UPDATE users SET ip = INET_ATON(‘{$_SERVER[‘REMOTE_ADDR’]}’) WHERE user_id = $user_id”;</p>
<h2 id="固定长度（静态）的表会更快"><a href="#固定长度（静态）的表会更快" class="headerlink" title="固定长度（静态）的表会更快"></a>固定长度（静态）的表会更快</h2><p>（译者注：这里提到的表的长度，实际是指表头的长度，即表中每条数据占用的空间大小，而不是指表的数据量）</p>
<p>如果表中所有列都是“固定长度”，那么这个表被认为是“静态”或“固定长度”的。不固定的列类型包括 VARCHAR、TEXT、BLOB等。即使表中只包含一个这些类型的列，这个表就不再是固定长度的，MySQL 引擎会以不同的方式来处理它。<br>固定长度的表会提高性能，因为 MySQL 引擎在记录中检索的时候速度会更快。如果想读取表中的某一地，它可以直接计算出这一行的位置。如果行的大小不固定，那就需要在主键中进行检索。</p>
<p>它们也易于缓存，崩溃后容易重建。不过它们也会占用更多空间。例如，如果你把一个 VARCHAR(20) 的字符改为 CHAR(20) 类型，它会总是占用 20 个字节，不管里面存的是什么内容。</p>
<p>你可以使用“垂直分区”技术，将长度变化的列拆分到另一张表中。来看看：</p>
<h2 id="垂直分区"><a href="#垂直分区" class="headerlink" title="垂直分区"></a>垂直分区</h2><p>垂直分区是为了优化表结构而对其进行纵向拆分的行为。</p>
<p>示例 1: 你可能会有一张用户表，包含家庭住址，而这个不是一个常用数据。这时候你可以选择把表拆分开，将住址信息保存到另一个表中。这样你的主用户表就会更小。如你所知，表越小越快。</p>
<p>示例 2: 表中有一个 “last_login” 字段，用户每次登录网站都会更新这个字段，而每次更新都会导致这个表缓存的查询数据被清空。这种情况下你可以将那个字段放到另一张表里，保持用户表更新量最小。</p>
<p>不过你也需要确保不会经常联合查询分开后的两张表，要不然你就得忍受由这带来的性能下降。</p>
<h2 id="拆分大型DELETE或INSERT语句"><a href="#拆分大型DELETE或INSERT语句" class="headerlink" title="拆分大型DELETE或INSERT语句"></a>拆分大型DELETE或INSERT语句</h2><p>如果你需要在网站上执行大型DELETE或INSERT查询，则需要注意不要影响网络流量。当执行大型语句时，它会锁表并使你的Web应用程序停止。<br>Apach运行许多并行进程/线程。 因此它执行脚本效率很高。所以服务器不期望打开过多的连接和进程，这很消耗资源，特别是内存。</p>
<p>如果你锁表很长时间（如30秒或更长），在一个高流量的网站，会导致进程和查询堆积，处理这些进程和查询可能需要很长时间，最终甚至使你的网站崩溃。<br>如果你的维护脚本需要删除大量的行，只需使用LIMIT子句，以避免阻塞。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">while (1) &#123;</div><div class="line">    mysql_query(&quot;DELETE FROM logs WHERE log_date &lt;= &apos;2009-10-01&apos; LIMIT 10000&quot;);</div><div class="line">    if (mysql_affected_rows() == 0) &#123;</div><div class="line">        // done deleting</div><div class="line">        break;</div><div class="line">    &#125;</div><div class="line">    // you can even pause a bit</div><div class="line">    usleep(50000);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="越少的列越快"><a href="#越少的列越快" class="headerlink" title="越少的列越快"></a>越少的列越快</h2><p>对于数据库引擎，磁盘可能是最重要的瓶颈。更小更紧凑的数据、减少磁盘传输量，通常有助于性能提高。</p>
<p>MySQL文档Storage Requirements 有所有数据类型清单。</p>
<p>如果已知表具有很少的行，则没有理由是主键类型为INT，可以用MEDIUMINT、SMALLINT代替，甚至在某些情况下使用TINYINT。 如果不需要完整时间记录，请使用DATE而不是DATETIME。</p>
<p>确保留下合理的扩展空间，不然你可能会像Slashdot这样。</p>
<h2 id="选择正确的存储引擎"><a href="#选择正确的存储引擎" class="headerlink" title="选择正确的存储引擎"></a>选择正确的存储引擎</h2><p>MySQL有两个主要存储引擎，MyISAM和InnoDB。 每个都有自己的优点和缺点。</p>
<p>MyISAM适用于读取繁重的应用程序，但是当有很多写入时它不能很好地扩展。 即使你正在更新一行的一个字段，整个表也被锁定，并且在语句执行完成之前，其他进程甚至无法读取该字段。 MyISAM在计算SELECT COUNT（*）的查询时非常快。</p>
<p>InnoDB是一个更复杂的存储引擎，对于大多数小的应用程序，它比MyISAM慢。 但它支持基于行的锁定，使其更好地扩展。 它还支持一些更高级的功能，比如事务。</p>
<ul>
<li>MyISAM存储引擎</li>
<li>InnoDB存储引擎</li>
</ul>
<h2 id="使用对象关系映射器（ORM-Object-Relational-Mapper）"><a href="#使用对象关系映射器（ORM-Object-Relational-Mapper）" class="headerlink" title="使用对象关系映射器（ORM, Object Relational Mapper）"></a>使用对象关系映射器（ORM, Object Relational Mapper）</h2><p>通过使用ORM（对象关系映射器），你可以获得一定的性能提升。ORM可以完成的一切事情，手动编码也可完成。但这可能意味着需要太多额外的工作，并且需要高水平的专业知识。</p>
<p>ORM以“延迟加载”著称。这意味着它们仅在需要时获取实际值。但是你需要小心处理他们，否则你可能最终创建了许多微型查询，这会降低数据库性能。</p>
<p>ORM还可以将多个查询批处理到事务中，其操作速度比向数据库发送单个查询快得多。</p>
<p>目前我最喜欢的PHP-ORM是Doctrine。我写了一篇关于如何安装Doctrine与CodeIgniter的文章（install Doctrine with CodeIgniter）。</p>
<h2 id="小心使用持久连接"><a href="#小心使用持久连接" class="headerlink" title="小心使用持久连接"></a>小心使用持久连接</h2><p>持久连接意味着减少重建连接到MySQL的成本。 当持久连接被创建时，它将保持打开状态直到脚本完成运行。 因为Apache重用它的子进程，下一次进程运行一个新的脚本时，它将重用相同的MySQL连接。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">● PHP：mysql_pconnect()</div></pre></td></tr></table></figure></p>
<p>理论上看起来不错。 但从我个人（和许多其他人）的经验看来，这个功能可能会导致更多麻烦。 你可能会出现连接数限制问题、内存问题等等。</p>
<p>Apache总是并行运行的，它创建许多子进程。 这是持久连接在这种环境中不能很好工作的主要原因。 在你考虑使用mysql_pconnect()之前，请咨询你的系统管理员。</p>

				<div class="clearfix"></div>
				<hr class="nogutter">
				<nav class="pagination" role="pagination">
    
    
    <a class="pull-right" href="/2016/12/05/Tomcat_performance_optimization/">
        Tomcat性能调优 →
    </a>
    
</nav>

				<div class="duoshuo">
<div class="ds-thread" data-thread-key="2016/12/06/mysql_bestpractice/" data-title="MySQL最佳实践" data-url="https://kiroswu.github.io/2016/12/06/mysql_bestpractice/"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"kiroswu"};
(function() {
	var ds = document.createElement('script');
	ds.type = 'text/javascript';ds.async = true;
	ds.src = '/js/embed.js';
	ds.charset = 'UTF-8';
	(document.getElementsByTagName('head')[0] 
	 || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script>
</div>
			</div>			
			<div id="updown" class="col-md-2"><span class="up"></span><span class="down"></span></div>
		</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2016<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By Kiros Wu. All Rights Reserved.
                </p>
               
            </div>
					
            <div class="social col-md-4">
				<img src="/img/ITSenior.jpg" width="100"></img>&nbsp
				<img src="/img/cr.jpg" width="100"></img>
                <ul>
                    
                    <li><a href="https://github.com/kiroswu" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="http://weibo.com/u/2363324471" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a>&nbsp;</li>
                    
                </ul>
				
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
        
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };
    
    resizeHero();
    
    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/jquery.flexslider-min.js"></script><!-- Flexslider plugin -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->

<!-- Initiate flexslider plugin -->
<script type="text/javascript">
    $(document).ready(function($) {
      $('.flexslider').flexslider({
        animation: "fade",
        prevText: "",
        nextText: "",
        directionNav: true
      });
    });
</script>

</body>
</html>
